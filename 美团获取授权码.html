<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My Page</title>
</head>
<body>

  <!-- 输入框 -->
  <button onclick="openFrame(1)">获取美团授权码</button>

  <button onclick="openFrame(2)">授权码换取token</button>

  <!-- iframe 页面 -->
  <iframe id="my-iframe" src="" style="width: 960px; height: 785px; display: none;"></iframe>

  <!-- iframe 页面 -->
  <iframe id="my-iframe-token" src="" style="width: 960px; height: 785px; display: none;"></iframe>
  <!-- 消息显示区域 -->
  <div id="message"></div>

  <script>
    // 获取元素
    var iframe = document.getElementById("my-iframe");
    var iframeToken = document.getElementById("my-iframe-token");
    var messageDiv = document.getElementById("message");
    var type = 0;
    var authCodeData = null;
    // 监听 window 消息
    window.addEventListener("message", function(event) {
      console.log(event, "全量数据")
      if (type == 1){
        authCodeData = event.data
      }
      var data = JSON.stringify(event.data);
      messageDiv.innerHTML += "<p>" + data + "</p>";  // 将消息添加到消息显示区域
      console.log(data);  // 将消息打印到控制台
      iframe.style.display = "none";  // 隐藏 iframe
    });

    // 打开 iframe 页面
    function openFrame(status) {
      if (status == 1){
        type = 1
        var url = 'https://e.dianping.com/dz-open/merchant/auth?app_key=d4d2b62ac4722121&state=teststate';
        iframe.setAttribute("src", url);
        iframe.style.display = "block";
      }else if(status == 2 && authCodeData != null){
        type = 2
        var url = 'https://openapi.dianping.com';
        iframeToken.setAttribute("src", url);
        iframeDoc = iframeToken.contentDocument || iframeToken.contentWindow.document;
        // 创建一个form元素
        var form = iframeDoc.createElement('form');

        // 设置form的属性和值
        form.action = `https://openapi.dianping.com/router/oauth/token?app_key=d4d2b62ac4722121&app_secret=592642e98186586e2417b13aebc34f47d1540fe5&auth_code=${authCodeData['auth_code']}&grant_type=authorization_code`;
        form.method = 'POST';
        // 将form元素添加到iframe文档中
        iframeDoc.body.appendChild(form);

        // 提交form表单
        form.submit();
        iframeToken.style.display = "block";
      }
    }
  </script>

</body>
</html>
