## 证书自动管理
* 自动申请证书验证服务，属于通用服务

### 安装 acme.sh 工具
```sh
curl https://get.acme.sh | sh

# 设置证书签发机构
acme.sh --set-default-ca  --server  letsencrypt
```

### 配置证书验证服务
1. deployment
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: acme-challenge
  namespace: acme-space
spec:
  replicas: 1
  selector:
    matchLabels:
      app: acme-challenge
  template:
    metadata:
      labels:
        app: acme-challenge
    spec:
      containers:
      - name: acme-challenge
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: acme-challenge
          mountPath: /usr/share/nginx/html/.well-known/acme-challenge
      volumes:
      - name: acme-challenge
        persistentVolumeClaim:
          claimName: acme-challenge-pvc
```
2. PersistentVolume
```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: acme-challenge-pv
  namespace: acme-space
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  storageClassName: local-storage
  local:
    path: /data/acme-challenge
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - k8s-master
```

3. PersistentVolumeClaim
```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: acme-challenge-pvc
  namespace: acme-space
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-storage
```

2. Service
```yaml
apiVersion: v1
kind: Service
metadata:
  name: acme-challenge
  namespace: acme-space
spec:
  ports:
  - port: 80
    targetPort: 80
  selector:
    app: acme-challenge
```

3. VirtualSerivce
* 如果采用了域名分流实际的业务的话，该VirtualSerivce不生效，因为会被实际的业务VirtualSerivce夺走了流量
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: acme-route
  namespace: acme-space
spec:
  hosts:
  - "*"
  gateways:
  - istio-ingressgateway
  http:
  - match:
    - uri:
        prefix: "/.well-known/acme-challenge/"
    route:
    - destination:
        host: acme-challenge.acme-space.svc.cluster.local
        port:
          number: 80
```
4. 修改对应的VirtualSerivce，添加域名认证的路径，与3选择一个方式即可
```yaml
# .... 之前的配置
  http:
    - match:
        - uri:
            prefix: /.well-known/acme-challenge/
      route:
        - destination:
            host: acme-challenge.acme-space.svc.cluster.local
            port:
              number: 80
```

### 自动签发/续签证书
* 由于 生成验证文件 和 签发证书同时进行，只能将文件目录挂在到上面的 nginx 中
```sh
vim auto_cert_bash.sh
#!/bin/bash

# 配置变量
ACME_HOME="/root/.acme.sh"
DOMAIN="yourdomain.com"
WEBROOT_DIR="/data/acme-challenge"
KUBE_NAMESPACE="acme-space"
DEPLOYMENT="acme-challenge"
CERT_PATH="${ACME_HOME}/${DOMAIN}_ecc"
PKCS12_PASSWORD="your_pkcs12_password"
NAMESPACE="teaeam"
CONFIGMAP_NAME="ssl-config"
DEPLOYMENT_NAME="teaeam-gateway"

# 帮助信息
function show_help() {
    echo "用法: $0 [选项]"
    echo "选项:"
    echo "  --help           显示帮助信息"
    echo "  --all            全流程运行（默认）"
    echo "  --issue-cert     仅申请证书"
    echo "  --convert-cert   仅转换证书为 .p12 格式"
    echo "  --update-config  仅更新 Kubernetes ConfigMap"
    echo "  --restart-app    仅重启 Spring Gateway 部署"
}

# 全局流程
function run_all() {
    issue_cert
    convert_cert
    update_config
    restart_app
}

# 申请证书
function issue_cert() {
    echo ">>> 开始申请证书..."
    mkdir -p "$WEBROOT_DIR"
    "$ACME_HOME/acme.sh" --issue -d $DOMAIN --webroot "$WEBROOT_DIR"
    if [ $? -ne 0 ]; then
        echo "Error: 证书申请失败。"
        exit 1
    fi
    echo "证书申请成功！"
}

# 转换证书为 .p12 格式
function convert_cert() {
    echo ">>> 转换证书为 .p12 格式..."
    openssl pkcs12 -export \
      -inkey "$CERT_PATH/$DOMAIN.key" \
      -in "$CERT_PATH/$DOMAIN.cer" \
      -certfile "$CERT_PATH/fullchain.cer" \
      -out "$CERT_PATH/$DOMAIN.p12" \
      -password pass:"$PKCS12_PASSWORD"
    if [ $? -ne 0 ]; then
        echo ".p12 文件生成失败，退出脚本。"
        exit 1
    fi
    echo ".p12 文件生成成功！路径：$CERT_PATH/$DOMAIN.p12"
}

# 只更新 Kubernetes ConfigMap
function update_configmap() {
    echo ">>> 删除原有 Kubernetes ConfigMap..."
    kubectl delete -n "$NAMESPACE" configmap "$CONFIGMAP_NAME"
    echo ">>> 更新 Kubernetes ConfigMap..."
    kubectl create configmap "$CONFIGMAP_NAME" \
      --from-file="your app config file name"="$CERT_PATH/$DOMAIN.p12" \
      --dry-run=client -o yaml | kubectl apply -n "$NAMESPACE" -f -
    if [ $? -ne 0 ]; then
        echo "ConfigMap 更新失败，退出脚本。"
        exit 1
    fi
    echo "ConfigMap 更新成功！"
}


# 重启 Spring Gateway 部署
function restart_app() {
    echo ">>> 重启 Spring Gateway 部署..."
    kubectl rollout restart deployment "$DEPLOYMENT_NAME" -n "$NAMESPACE"
    if [ $? -ne 0 ]; then
        echo "Spring Gateway 部署重启失败，退出脚本。"
        exit 1
    fi
    echo "Spring Gateway 部署重启成功！"
}

# 检查参数并执行相应模块
case "$1" in
    --help)
        show_help
        ;;
    --all)
        run_all
        ;;
    --issue-cert)
        issue_cert
        ;;
    --convert-cert)
        convert_cert
        ;;
    --update-config)
        update_configmap
        ;;
    --restart-app)
        restart_app
        ;;
    *)
        echo "无效选项: $1"
        show_help
        exit 1
        ;;
esac

# 脚本结束
echo "操作完成！"
exit 0
```

#### 自动更新
* 打开自动更新
```sh
acme.sh  --upgrade  --auto-upgrade
```

* 新增更新证书后需命令
```sh
vim /root/.acme.sh/yourdomain.com/yourdomain.com.conf
# 加上最后脚本命令
Le_ReloadCmd='/root/.acme.sh/auto_cert_bash.sh --convert-cert && /root/.acme.sh/auto_cert_bash.sh --update-config && /root/.acme.sh/auto_cert_bash.sh --restart-app'
```
