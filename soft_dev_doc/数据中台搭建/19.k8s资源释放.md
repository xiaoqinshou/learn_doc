## 前言
* 最坑的点，由于k8s+docker 太稳定了，稳定到某些pod 运行个几个月，1年2年的根本都不用重启，导致pod所产生的日志一直累积，最后撑爆了磁盘。

### 安装 logrotate
* centos 8.4 自带

### 配置日志轮转规则
```sh
sudo vim /etc/logrotate.d/docker-container-logs

/var/lib/docker/containers/*/*-json.log {
    daily                     # 每天轮转一次日志
    rotate 7                  # 保留 7 天的日志
    compress                  # 压缩旧日志
    delaycompress             # 延迟到下次轮转再压缩
    missingok                 # 忽略丢失的日志文件
    notifempty                # 不处理空文件
    copytruncate              # 截断日志文件（保持文件句柄）
}

# 测试配置
sudo logrotate -d /etc/logrotate.d/docker-container-logs

# 出现类似日志就成功了
...
considering log /var/lib/docker/containers
Creating new state
  Now: 2024-12-27 16:21
  Last rotated at 2024-12-27 16:00
  log does not need rotating (log has been already rotated)
...
```

### 配置定时任务
```sh
crontab -e
# 每天凌晨3.30分轮转日志
30 3 * * * root /usr/sbin/logrotate /etc/logrotate.conf
```

### 定期清理docker 资源
* 定期清理无用容器、镜像、网络
```sh
sudo vim /usr/local/bin/docker-clean.sh

#!/bin/bash
echo "Starting Docker cleanup at $(date)"
# 清理无用容器、镜像、网络和数据卷
# docker system prune -af --volumes
# 数据卷就不删了，万一意外删到PVC就麻烦了
docker system prune -af
echo "Docker cleanup completed at $(date)"

sudo chmod +x /usr/local/bin/docker-clean.sh

crontab -e

0 4 * * 0 root /usr/local/bin/docker-clean.sh
```

### 清理旧日志文件

```sh
sudo vim /etc/tmpfiles.d/docker-logs.conf

# 删除 7 天前的 Docker 日志
x /var/lib/docker/containers/*/*-json.log - - - 7d

sudo systemd-tmpfiles --create
```